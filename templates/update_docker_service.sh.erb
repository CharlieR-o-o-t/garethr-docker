#!/bin/bash
#
# Find all container's images for passed label
# Pulls a docker image
# Kills containers if image has been updated
# _Assumed_ that Systemd recreates container with new image
#

DOCKER_LABEL=$1

# check deps
declare -a deps=("update_docker_image.sh")
for dep in "${deps[@]}"; do
    command -v "$dep" >/dev/null 2>&1 \
        || { echo >&2 "I require $dep but it's not installed. Aborting."; exit 1; }
done

<%= @docker_command -%> ps -q --filter="label=$DOCKER_LABEL" | while read container; do
    image=$(<%= @docker_command -%> inspect --format='{{.Config.Image}}' $container);
    if update_docker_image.sh $image; then
        <%= @docker_command -%> kill $container;
    fi;
done
